# è‚¡ç¥¨æ•°æ®å®šæ—¶èŽ·å–åŠŸèƒ½è¯´æ˜Ž

## åŠŸèƒ½æ¦‚è¿°

å·²å®žçŽ°æ¯ä¸ªå·¥ä½œæ—¥ä¸‹åˆ3:30ä¹‹åŽè‡ªåŠ¨èŽ·å–Aè‚¡ã€æ¸¯è‚¡å’Œç¾Žè‚¡çš„è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯çš„å®šæ—¶ä»»åŠ¡ã€‚

## æ–‡ä»¶ç»“æž„

```
app/
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ stock_data_fetcher.py    # è‚¡ç¥¨æ•°æ®èŽ·å–æ¨¡å—
â””â”€â”€ main.py                       # ä¸»æœåŠ¡ï¼ˆå·²é›†æˆå®šæ—¶ä»»åŠ¡ï¼‰

scripts/
â””â”€â”€ test_stock_fetcher.py         # æµ‹è¯•è„šæœ¬

pyproject.toml                     # å·²æ·»åŠ akshareä¾èµ–
```

## æ ¸å¿ƒåŠŸèƒ½

### 1. StockDataFetcher ç±» (app/tasks/stock_data_fetcher.py)

**ä¸»è¦æ–¹æ³•ï¼š**
- `fetch_all_stock_info()`: èŽ·å–æ‰€æœ‰å¸‚åœºçš„è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
- `should_run_now()`: æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‰§è¡Œä»»åŠ¡ï¼ˆå·¥ä½œæ—¥ä¸”15:30ä¹‹åŽï¼‰

**æ•°æ®å­—æ®µï¼š**
- è‚¡ç¥¨ä»£ç 
- è‚¡ç¥¨ç®€ç§°
- å…¬å¸åç§°
- ä¸Šå¸‚æ—¶é—´

**æ”¯æŒçš„å¸‚åœºï¼š**
- **Aè‚¡**: ä½¿ç”¨ `ak.stock_info_a_code_name()`
- **æ¸¯è‚¡**: ä½¿ç”¨ `ak.stock_hk_spot_em()`
- **ç¾Žè‚¡**: ä½¿ç”¨ `ak.stock_us_spot_em()`

### 2. æ‰§è¡Œè§„åˆ™

- âœ… ä»…åœ¨å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€è‡³å‘¨äº”ï¼‰æ‰§è¡Œ
- âœ… ä»…åœ¨ä¸‹åˆ3:30ä¹‹åŽæ‰§è¡Œ
- âœ… æ¯å¤©åªæ‰§è¡Œä¸€æ¬¡
- âœ… æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ˜¯å¦åº”è¯¥æ‰§è¡Œ

### 3. é›†æˆåˆ°ä¸»æœåŠ¡

å®šæ—¶ä»»åŠ¡å·²é›†æˆåˆ° `app/main.py` ä¸­çš„ `TradingService`ï¼Œä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡å¾ªçŽ¯è¿è¡Œã€‚

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: å¯åŠ¨ä¸»æœåŠ¡ï¼ˆè‡ªåŠ¨è¿è¡Œå®šæ—¶ä»»åŠ¡ï¼‰

```bash
python3 app/main.py
```

ä¸»æœåŠ¡ä¼šå¯åŠ¨æ‰€æœ‰ä»»åŠ¡ï¼ŒåŒ…æ‹¬è‚¡ç¥¨æ•°æ®èŽ·å–ä»»åŠ¡ã€‚æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œç¬¦åˆæ¡ä»¶æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚

### æ–¹æ³•2: ç‹¬ç«‹æµ‹è¯•ï¼ˆæ— éœ€ç­‰å¾…æ‰§è¡Œæ—¶é—´ï¼‰

```bash
python3 scripts/test_stock_fetcher.py
```

æµ‹è¯•è„šæœ¬ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡æ•°æ®èŽ·å–ï¼Œç”¨äºŽéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚

## å®‰è£…ä¾èµ–

åœ¨è¿è¡Œä¹‹å‰ï¼Œéœ€è¦å®‰è£…ä¾èµ–ï¼š

```bash
# æ–¹æ³•1: å®‰è£…å®Œæ•´é¡¹ç›®
pip install -e .

# æ–¹æ³•2: ä»…å®‰è£…æ ¸å¿ƒä¾èµ–
pip install akshare pandas numpy pydantic pydantic-settings python-dotenv
```

## è¾“å‡ºç¤ºä¾‹

æ‰§è¡Œä»»åŠ¡æ—¶ä¼šè¾“å‡ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š

```
================================================================================
å¼€å§‹èŽ·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯...
æ‰§è¡Œæ—¶é—´: 2025-10-31 15:35:00
================================================================================

ðŸ“Š æ­£åœ¨èŽ·å–Aè‚¡è‚¡ç¥¨ä¿¡æ¯...
âœ“ Aè‚¡è‚¡ç¥¨æ•°é‡: 5234

Aè‚¡è‚¡ç¥¨åˆ—è¡¨ (å‰10æ¡):
  è‚¡ç¥¨ä»£ç   è‚¡ç¥¨ç®€ç§°   å…¬å¸åç§° ä¸Šå¸‚æ—¶é—´
  000001  å¹³å®‰é“¶è¡Œ   å¹³å®‰é“¶è¡Œ       -
  000002  ä¸‡ç§‘A     ä¸‡ç§‘A         -
  ...

... (å…± 5234 æ¡è®°å½•)

ðŸ“Š æ­£åœ¨èŽ·å–æ¸¯è‚¡è‚¡ç¥¨ä¿¡æ¯...
âœ“ æ¸¯è‚¡è‚¡ç¥¨æ•°é‡: 2598

æ¸¯è‚¡è‚¡ç¥¨åˆ—è¡¨ (å‰10æ¡):
  è‚¡ç¥¨ä»£ç   è‚¡ç¥¨ç®€ç§°   å…¬å¸åç§° ä¸Šå¸‚æ—¶é—´
  00001   é•¿å’Œ      é•¿å’Œ         -
  00002   ä¸­ç”µæŽ§è‚¡   ä¸­ç”µæŽ§è‚¡      -
  ...

... (å…± 2598 æ¡è®°å½•)

ðŸ“Š æ­£åœ¨èŽ·å–ç¾Žè‚¡è‚¡ç¥¨ä¿¡æ¯...
âœ“ ç¾Žè‚¡è‚¡ç¥¨æ•°é‡: 8742

ç¾Žè‚¡è‚¡ç¥¨åˆ—è¡¨ (å‰10æ¡):
  è‚¡ç¥¨ä»£ç   è‚¡ç¥¨ç®€ç§°   å…¬å¸åç§° ä¸Šå¸‚æ—¶é—´
  AAPL    è‹¹æžœ      è‹¹æžœ         -
  MSFT    å¾®è½¯      å¾®è½¯         -
  ...

... (å…± 8742 æ¡è®°å½•)

================================================================================
æ‰€æœ‰å¸‚åœºè‚¡ç¥¨ä¿¡æ¯èŽ·å–å®Œæˆï¼
================================================================================
```

## æ³¨æ„äº‹é¡¹

1. **æ—¶é—´é™åˆ¶**: é»˜è®¤åªåœ¨å·¥ä½œæ—¥15:30ä¹‹åŽæ‰§è¡Œï¼Œå‘¨æœ«å’ŒèŠ‚å‡æ—¥ä¸æ‰§è¡Œ
2. **æ¯æ—¥ä¸€æ¬¡**: æ¯å¤©æœ€å¤šæ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…é‡å¤èŽ·å–
3. **å¼‚æ­¥æ‰§è¡Œ**: ä½¿ç”¨asyncioå®žçŽ°ï¼Œä¸ä¼šé˜»å¡žå…¶ä»–ä»»åŠ¡
4. **é”™è¯¯å¤„ç†**: åŒ…å«å®Œæ•´çš„å¼‚å¸¸æ•èŽ·å’Œæ—¥å¿—è®°å½•
5. **æ•°æ®æ¥æº**: æ•°æ®æ¥è‡ªakshareåº“ï¼Œéœ€è¦ç½‘ç»œè¿žæŽ¥

## è‡ªå®šä¹‰é…ç½®

å¦‚éœ€ä¿®æ”¹æ‰§è¡Œæ—¶é—´æˆ–é¢‘çŽ‡ï¼Œå¯ä»¥ç¼–è¾‘ä»¥ä¸‹ä½ç½®ï¼š

### ä¿®æ”¹æ£€æŸ¥æ—¶é—´ï¼ˆapp/tasks/stock_data_fetcher.pyï¼‰
```python
def should_run_now(self) -> bool:
    # ä¿®æ”¹è¿™é‡Œçš„æ—¶é—´æ£€æŸ¥é€»è¾‘
    if now.hour < 15 or (now.hour == 15 and now.minute < 30):
        return False
```

### ä¿®æ”¹æ£€æŸ¥é¢‘çŽ‡ï¼ˆapp/main.pyï¼‰
```python
async def _stock_data_fetch_loop(self):
    # ä¿®æ”¹è¿™é‡Œçš„æ£€æŸ¥é—´éš”ï¼ˆå•ä½ï¼šç§’ï¼‰
    await asyncio.sleep(600)  # å½“å‰æ˜¯10åˆ†é’Ÿ
```

## åŽç»­æ‰©å±•å»ºè®®

1. **æ•°æ®å­˜å‚¨**: å°†èŽ·å–çš„æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“
2. **æ•°æ®åŽ»é‡**: å®žçŽ°å¢žé‡æ›´æ–°ï¼ŒåªèŽ·å–æ–°å¢žæˆ–å˜æ›´çš„è‚¡ç¥¨
3. **é€šçŸ¥åŠŸèƒ½**: ä»»åŠ¡å®ŒæˆåŽå‘é€é€šçŸ¥ï¼ˆé‚®ä»¶/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
4. **æ•°æ®å¯¼å‡º**: æ”¯æŒå¯¼å‡ºä¸ºCSVã€Excelç­‰æ ¼å¼
5. **æ›´å¤šå­—æ®µ**: èŽ·å–æ›´è¯¦ç»†çš„è‚¡ç¥¨ä¿¡æ¯ï¼ˆè¡Œä¸šã€å¸‚å€¼ç­‰ï¼‰
