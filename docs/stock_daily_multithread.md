# 股票日线数据多线程同步功能

## 概述

将股票日线数据同步任务从串行处理改造为多线程并发处理，大幅提升数据同步效率。

## 主要改进

### 1. 多线程并发处理
- 使用 `ThreadPoolExecutor` 实现线程池
- 每只股票分配一个独立线程进行处理
- 默认最大并发线程数: 10 (可配置)

### 2. 线程安全统计
- 使用 `Lock` 保证计数器线程安全
- 实时统计成功/失败/已处理数量
- 每处理10只股票输出一次进度

### 3. 性能优化
- 同步版本的 HTTP 请求 (避免事件循环阻塞)
- 同步版本的 Baostock API 调用
- 批量保存数据 (1000条/批)

### 4. 配置化管理
- 通过环境变量 `STOCK_DAILY_MAX_WORKERS` 配置线程数
- 默认值: 10
- 可根据服务器性能和网络条件调整

## 配置说明

### 环境变量

在 `.env` 文件中添加:

```bash
# 日线数据同步最大并发线程数
STOCK_DAILY_MAX_WORKERS=10
```

### 配置参数

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `stock_daily_max_workers` | int | 10 | 最大并发线程数 |

### 建议配置

- **小型服务器** (2核4G): 5-10 线程
- **中型服务器** (4核8G): 10-20 线程
- **大型服务器** (8核16G): 20-50 线程

> 注意: 线程数不是越多越好，需要考虑:
> 1. CPU 核心数
> 2. 网络带宽
> 3. Baostock API 限制
> 4. 数据库写入能力

## 代码结构

### 主要方法

#### `sync_stock_daily()` - 异步主方法
```python
async def sync_stock_daily(self):
    """
    同步股票日线数据（从 Baostock）- 多线程并发版本

    流程：
    1. 获取所有股票基本信息
    2. 使用线程池并发处理每只股票
    3. 每个线程处理一只股票的3种复权类型数据
    4. 线程安全地统计成功和失败数量
    """
```

#### `_process_stocks_in_threadpool()` - 线程池处理
```python
def _process_stocks_in_threadpool(self, stocks: List[Dict], today: str):
    """
    在线程池中并发处理所有股票

    使用 ThreadPoolExecutor 管理线程
    使用 as_completed 获取完成的任务
    """
```

#### `_process_single_stock()` - 单股票处理
```python
def _process_single_stock(self, stock: Dict, idx: int, total_stocks: int, today: str) -> bool:
    """
    处理单个股票的日线数据同步（同步方法，用于线程池执行）

    处理流程：
    1. 查询3种复权类型的最后交易日
    2. 确定查询起始日期
    3. 从 Baostock 获取数据
    4. 批量保存到数据库
    """
```

### 辅助方法

#### 同步版本的方法
- `_get_last_trade_date_sync()` - 查询最后交易日
- `_fetch_stock_daily_from_baostock_sync()` - 获取日线数据
- `_save_daily_data_batch_sync()` - 批量保存数据

## 使用示例

### 运行测试脚本

```bash
python scripts/test_daily_sync_multithread.py
```

### 手动触发同步

```python
from app.tasks.stock_daily_fetcher import StockDailyFetcher
import asyncio

async def sync():
    fetcher = StockDailyFetcher()
    await fetcher.sync_stock_daily()

asyncio.run(sync())
```

## 日志输出示例

```
================================================================================
开始同步股票日线数据（Baostock - 多线程并发）...
执行时间: 2025-01-15 16:00:00
并发线程数: 10
================================================================================

📊 步骤1: 获取所有股票基本信息...
✓ 共获取 5432 只股票

📊 登录 Baostock...
✓ Baostock 登录成功

📊 步骤2: 开始并发处理股票数据...
  线程池大小: 10

[1/5432] 处理股票: 000001.SZ 平安银行
  上市日期: 1991-04-03
  ...

  进度: 10/5432 (0.2%) | 成功: 10 | 失败: 0
  进度: 20/5432 (0.4%) | 成功: 19 | 失败: 1
  ...
  进度: 5430/5432 (100.0%) | 成功: 5400 | 失败: 32

✓ Baostock 登出成功

================================================================================
✓ 股票日线数据同步完成！
  成功: 5400/5432
  失败: 32/5432
  总耗时: 45分32秒
  平均速度: 0.50秒/股
================================================================================
```

## 性能对比

假设有 5000 只股票需要同步:

### 串行处理 (之前)
- 处理时间: 约 2.5 秒/股
- 总耗时: 5000 × 2.5 = 12500 秒 ≈ 3.5 小时

### 并发处理 (10线程)
- 处理时间: 约 0.5 秒/股
- 总耗时: 5000 × 0.5 / 10 ≈ 250 秒 ≈ 4 分钟

**性能提升: 约 50 倍**

## 注意事项

### 1. Baostock 连接
- 确保 Baostock 登录成功
- 线程池中每个线程共享同一个 Baostock 连接
- 如遇连接问题，可能需要每个线程独立登录

### 2. 数据库连接
- HTTP 客户端使用同步模式 (`httpx.Client`)
- 每个请求独立创建连接，自动管理连接池

### 3. 错误处理
- 单个股票处理失败不影响其他股票
- 异常会被捕获并记录到日志
- 最终统计会显示成功和失败数量

### 4. 资源限制
- 线程数不宜过多，避免资源耗尽
- 建议根据服务器配置调整
- 监控 CPU、内存、网络使用情况

## 后续优化建议

1. **动态线程池**: 根据系统负载动态调整线程数
2. **断点续传**: 支持任务中断后从断点继续
3. **优先级队列**: 优先处理活跃度高的股票
4. **重试机制**: 对失败的股票自动重试
5. **监控告警**: 集成监控系统，失败率过高时告警

## 版本历史

- **v1.0** (2025-01-15): 初始版本，实现基础多线程功能
  - 线程池并发处理
  - 线程安全统计
  - 进度实时显示
  - 配置化管理
